/* eslint-env node */
/**
 * Script para limpiar la vulnerabilidad XSS en la base de datos
 * Elimina el estudiante con cÃ³digo JavaScript malicioso
 */

import pool from '../config/db.js';

async function cleanXSSVulnerability() {
  try {
    console.log('ğŸ” Buscando estudiante con cÃ³digo malicioso...');
    
    // Buscar el estudiante con alert() en el nombre
    const [students] = await pool.promise().query(
      `SELECT id, name, email, first_name, last_name FROM students 
       WHERE name LIKE '%alert%' OR first_name LIKE '%alert%'`
    );

    if (students.length === 0) {
      console.log('âœ… No se encontraron estudiantes con cÃ³digo malicioso.');
      process.exit(0);
    }

    console.log(`âš ï¸  Encontrados ${students.length} estudiante(s) con cÃ³digo potencialmente malicioso:`);
    students.forEach(student => {
      console.log(`   - ID: ${student.id}, Nombre: ${student.name}, Email: ${student.email}`);
    });

    // Eliminar el estudiante malicioso (ID 13 segÃºn el dump)
    const studentIdToDelete = 13;
    
    console.log(`\nğŸ—‘ï¸  Eliminando estudiante con ID ${studentIdToDelete}...`);
    
    await pool.promise().query('DELETE FROM students WHERE id = ?', [studentIdToDelete]);
    
    console.log('âœ… Estudiante malicioso eliminado exitosamente.');
    console.log('\nğŸ“ RecomendaciÃ³n: Implementar validaciÃ³n de entrada en el backend para prevenir futuros ataques XSS.');
    
    process.exit(0);
  } catch (error) {
    console.error('âŒ Error al limpiar vulnerabilidad XSS:', error);
    process.exit(1);
  }
}

cleanXSSVulnerability();
